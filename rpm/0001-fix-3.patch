From b25d5f818d119de8844721131d954d2e4b22bcd2 Mon Sep 17 00:00:00 2001
From: chenshijie <chenshijie@uniontech.com>
Date: Thu, 25 Nov 2021 11:59:06 +0800
Subject: [PATCH] =?UTF-8?q?fix:=20=E4=BF=AE=E5=A4=8D=E8=BF=9B=E5=85=A5?=
 =?UTF-8?q?=E6=8E=A7=E5=88=B6=E4=B8=AD=E5=BF=83=EF=BC=8C=E7=82=B9=E5=87=BB?=
 =?UTF-8?q?=E8=BE=93=E5=85=A5=E6=B3=95=E5=90=8E=EF=BC=8C=E5=8D=A1=E9=A1=BF?=
 =?UTF-8?q?3=E7=A7=92=E5=90=8E=E6=98=BE=E7=A4=BA=E8=BE=93=E5=85=A5?=
 =?UTF-8?q?=E6=B3=95=E7=AE=A1=E7=90=86=E9=80=89=E9=A1=B9?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

desc: https://pms.uniontech.com/zentao/bug-view-79691.html

Log: 修复进入控制中心，点击输入法后，卡顿3秒后显示输入法管理选项
Change-Id: I8c8ee3d404f8567ac097815ca6bdba816bc5aa68
---
 rpm/deepin-fcitxconfigtool-plugin.spec        |  2 +-
 src/window/availwidget.cpp                    | 24 ++++++++++++++++---
 src/window/availwidget.h                      |  4 ++++
 src/window/imaddwindow.cpp                    |  7 ++++++
 src/window/imaddwindow.h                      |  1 +
 src/window/imwindow.cpp                       |  1 +
 .../deepin-fcitxconfigtool-plugin_en_US.ts    | 10 ++++----
 7 files changed, 40 insertions(+), 9 deletions(-)
 mode change 100644 => 100755 rpm/deepin-fcitxconfigtool-plugin.spec

diff --git a/rpm/deepin-fcitxconfigtool-plugin.spec b/rpm/deepin-fcitxconfigtool-plugin.spec
old mode 100644
new mode 100755
index 10bea20..822f68f
--- a/rpm/deepin-fcitxconfigtool-plugin.spec
+++ b/rpm/deepin-fcitxconfigtool-plugin.spec
@@ -6,7 +6,7 @@
 
 Name:		deepin-fcitxconfigtool-plugin
 Summary:		An input method framework
-Version:		0.1.17
+Version:		0.1.35
 Release:		1%{?dist}
 License:		GPLv2+
 URL:			https://fcitx-im.org/wiki/Fcitx
diff --git a/src/window/availwidget.cpp b/src/window/availwidget.cpp
index ac76508..39667d5 100644
--- a/src/window/availwidget.cpp
+++ b/src/window/availwidget.cpp
@@ -28,7 +28,6 @@
 #include "fcitxInterface/global.h"
 #include "fcitxInterface/i18n.h"
 #include <QVBoxLayout>
-
 using namespace Fcitx;
 using namespace dcc_fcitx_configtool::widgets;
 bool operator==(const FcitxQtInputMethodItem &item, const FcitxQtInputMethodItem &item2);
@@ -77,7 +76,7 @@ AvailWidget::AvailWidget(QWidget *parent)
     : QWidget(parent)
 {
     initUI();
-    onUpdateUI(IMModel::instance()->getAvailIMList());
+    //onUpdateUI(IMModel::instance()->getAvailIMList());
     initConnect();
 }
 
@@ -209,7 +208,6 @@ void AvailWidget::onUpdateUI(FcitxQtInputMethodItemList IMlist)
         }
     }
 }
-
 void AvailWidget::clearItemStatus()
 {
     m_selectItem = FcitxQtInputMethodItem();
@@ -249,3 +247,23 @@ void AvailWidget::onSearchIM(const QString &str)
         clearItemStatusAndFilter(m_searchIMGroup, true);
     }
 }
+void AvailWidget::slotUpdateAvailIMList()
+{
+    const FcitxQtInputMethodItemList & IMlist  = IMModel::instance()->getAvailIMList();
+    onUpdateUI(IMlist);
+
+}
+void AvailWidget::loadIMList()
+{
+    QThread* thread = new QThread(this);
+    connect(thread, &QThread::finished, [=]()
+    {
+       thread->deleteLater();
+    });
+     connect(thread, &QThread::started, [=]()
+     {
+        QMetaObject::invokeMethod(thread->parent(), "slotUpdateAvailIMList");
+        thread->quit();
+     });
+     thread->start();
+}
diff --git a/src/window/availwidget.h b/src/window/availwidget.h
index b29bf49..df010b8 100644
--- a/src/window/availwidget.h
+++ b/src/window/availwidget.h
@@ -39,9 +39,13 @@ public:
     ~AvailWidget();
     void clearItemStatus(); //清除item选中状态
     const FcitxQtInputMethodItem &getSeleteIm() const { return m_selectItem; } //获取选中item
+    void loadIMList();//线程方式加载输入法列表
 public slots:
     void onSearchIM(const QString &str); //搜索输入法
     void onUpdateUI(FcitxQtInputMethodItemList); //更新界面
+public slots:
+    void slotUpdateAvailIMList();//加载输入法槽函数
+
 signals:
     void seleteIM(bool); //选中状态信号 true 选中 false 未选中
 
diff --git a/src/window/imaddwindow.cpp b/src/window/imaddwindow.cpp
index b518790..8c5f1d3 100644
--- a/src/window/imaddwindow.cpp
+++ b/src/window/imaddwindow.cpp
@@ -30,6 +30,7 @@
 #include <DSearchEdit>
 #include <DFontSizeManager>
 #include <QProcess>
+#include <QTimer>
 using namespace dcc_fcitx_configtool::widgets;
 
 IMAddWindow::IMAddWindow(QWidget *parent)
@@ -115,6 +116,11 @@ void IMAddWindow::initConnect()
     connect(m_availWidget, &AvailWidget::seleteIM, m_buttonTuple->rightButton(), &QPushButton::setEnabled);
     connect(m_searchLEdit, &DSearchEdit::textChanged, m_availWidget, &AvailWidget::onSearchIM);
     connect(this, &IMAddWindow::addIM, IMModel::instance(), &IMModel::onAddIMItem);
+
+    QTimer::singleShot(1,this,[&]()
+    {
+        m_availWidget->loadIMList();
+    });
 }
 
 void IMAddWindow::updateUI()
@@ -124,6 +130,7 @@ void IMAddWindow::updateUI()
     if (!m_searchLEdit->text().isEmpty()) {
         m_searchLEdit->clear();
     }
+    
     m_availWidget->clearItemStatus();
 }
 
diff --git a/src/window/imaddwindow.h b/src/window/imaddwindow.h
index 90fb6bb..d0bc62c 100644
--- a/src/window/imaddwindow.h
+++ b/src/window/imaddwindow.h
@@ -49,6 +49,7 @@ public:
 signals:
     void popSettingsWindow(); //弹出设置窗口
     void addIM(const FcitxQtInputMethodItem &item);
+    void pushItemAvailwidget(const FcitxQtInputMethodItem &);
 
 private:
     void initUI(); //初始化界面
diff --git a/src/window/imwindow.cpp b/src/window/imwindow.cpp
index f3427ff..ec8cfd5 100644
--- a/src/window/imwindow.cpp
+++ b/src/window/imwindow.cpp
@@ -182,4 +182,5 @@ void IMWindow::initConnect()
         });
     */
 
+    
 }
diff --git a/translations/deepin-fcitxconfigtool-plugin_en_US.ts b/translations/deepin-fcitxconfigtool-plugin_en_US.ts
index c5f07ba..e14d66b 100644
--- a/translations/deepin-fcitxconfigtool-plugin_en_US.ts
+++ b/translations/deepin-fcitxconfigtool-plugin_en_US.ts
@@ -28,29 +28,29 @@
 <context>
     <name>IMAddWindow</name>
     <message>
-        <location filename="../src/window/imaddwindow.cpp" line="61"/>
+        <location filename="../src/window/imaddwindow.cpp" line="62"/>
         <source>Add Input Method</source>
         <translation type="unfinished"></translation>
     </message>
     <message>
-        <location filename="../src/window/imaddwindow.cpp" line="70"/>
+        <location filename="../src/window/imaddwindow.cpp" line="71"/>
         <source>Search</source>
         <translation type="unfinished"></translation>
     </message>
     <message>
-        <location filename="../src/window/imaddwindow.cpp" line="81"/>
+        <location filename="../src/window/imaddwindow.cpp" line="82"/>
         <source>Find more in App Store</source>
         <translation type="unfinished"></translation>
     </message>
     <message>
-        <location filename="../src/window/imaddwindow.cpp" line="89"/>
         <location filename="../src/window/imaddwindow.cpp" line="90"/>
+        <location filename="../src/window/imaddwindow.cpp" line="91"/>
         <source>Add</source>
         <translation type="unfinished"></translation>
     </message>
     <message>
-        <location filename="../src/window/imaddwindow.cpp" line="91"/>
         <location filename="../src/window/imaddwindow.cpp" line="92"/>
+        <location filename="../src/window/imaddwindow.cpp" line="93"/>
         <source>Cancel</source>
         <translation type="unfinished"></translation>
     </message>
-- 
2.20.1

